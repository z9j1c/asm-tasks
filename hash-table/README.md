### HashTable Lab

#### Исследуемый объект

`StringSet` -- класс множества `c-style` строк, основанный на хэш-таблице.
Алгоритм хеширования -- `fnv1a32`.

Цель: добиться ускорения поиска в хэш-таблице при замене части кода на написанный вручную `asm`.

#### RealWords Test

За основу взят [датасет](https://www.kaggle.com/rtatman/english-word-frequency) с выборкой `333,333` самых частотных английских слов из `Google Web Trillion Word Corpus`. Количества слов уменьшены в `100,000` раз и перемешаны вихрем Мерсенна (`python random.shuffle()`).

Тест состоит из помещения всех выбранных слов в `StringSet` и поиском каждого слова `100` раз.

Анализ количества инструкций, выполненых каждым методом/функцией оценивается `valgrind'ом` с параметром `--tool=cachegrind`.

##### -O0 тесты

Первые тесты проведём при компиляции с флагом `-O0`.

Код, только на `C++` дал следующий результат:

```
--------------------------------------------------------------------------------
Ir             I1mr  ILmr  Dr             D1mr          DLmr        Dw             D1mw      DLmw      
--------------------------------------------------------------------------------
96,762,725,106 1,879 1,869 39,924,656,225 1,227,798,623 143,876,237 11,154,247,849 1,692,048 1,584,516  PROGRAM TOTALS

--------------------------------------------------------------------------------
Ir             I1mr ILmr Dr             D1mr        DLmr       Dw            D1mw    DLmw     file:function
--------------------------------------------------------------------------------
41,865,446,460    1    1 20,351,431,815  54,004,452 53,904,749 5,232,661,450       0       0  ???:StringSet::Hash(char const*)
26,964,385,800    3    3 11,229,370,000 664,863,054  8,720,404 4,653,123,300       0       0  ???:StringSet::Find(char const*)
13,565,388,270    9    9  3,007,687,415 427,800,008  7,472,789             0       0       0  ???:__strcmp_avx2
13,196,342,047   11   11  4,540,774,538  73,735,702 73,636,137 1,174,010,946 719,374 719,374  ???:test_real_words(char const*)
   583,581,741  276  275    582,735,183      26,728         64           519      22      14  ???:???
   439,913,310   10   10    167,761,213   6,776,492     49,574    58,880,409       2       0  ???:StringSet::Insert(char const*)
```

Сразу заметно большое количество инструкций, приходящееся на `StringSet::Hash`, возможно, стоит сделать его `inline`. На следующем месте `StringSet::Find`, его-то и перепишем полностью на `asm'е`.

Так же заметим, что активно используется векторизованный `__strcmp_avx2`, значит, не стоит своими силами переписывать непосредственное сравнение строк и оставить вызов `strcmp`.

С полностью переписанным на `asm` методом `StringSet::Find` получаем следующий вывод `Kcachegrind`:

```
--------------------------------------------------------------------------------
Ir             I1mr  ILmr  Dr             D1mr          DLmr        Dw            D1mw      DLmw      
--------------------------------------------------------------------------------
61,981,465,158 1,887 1,876 16,127,927,134 1,227,459,988 143,876,237 2,471,700,849 1,691,713 1,584,516  PROGRAM TOTALS

--------------------------------------------------------------------------------
Ir             I1mr ILmr Dr            D1mr        DLmr       Dw            D1mw    DLmw     file:function
--------------------------------------------------------------------------------
34,213,848,041  277  276 8,163,450,283 718,678,659 62,612,274 1,150,991,519      22      14  ???:???
13,565,386,170    9    9 3,007,686,915 427,639,932  7,472,789             0       0       0  ???:__strcmp_avx2
13,196,342,047   11   11 4,540,774,538  73,735,702 73,636,136 1,174,010,946 719,374 719,374  ???:test_real_words(char const*)
   439,913,310   10   10   167,761,213   6,776,726     49,575    58,880,409       2       0  ???:StringSet::Insert(char const*)
   418,308,060    1    1   203,358,115      36,775     12,941    52,246,750       0       0  ???:StringSet::Hash(char const*)
```

`StringSet::Find` исчез из топа по количеству использованных инструкций. Общее улучшение с `96,762,725,106` до `61,981,465,158` инструкций на весь тест, т.е. убыстрение в `1.56` раза.

##### -O2 тесты

Эти тесты отличаются от предыдущих лишь флагом `-O2` для `g++`.

`C++`:

```
--------------------------------------------------------------------------------
Ir             I1mr  ILmr  Dr             D1mr          DLmr        Dw            D1mw      DLmw      
--------------------------------------------------------------------------------
57,492,160,682 1,867 1,856 13,763,142,680 1,227,456,894 143,876,280 3,568,234,022 1,690,810 1,584,526  PROGRAM TOTALS

--------------------------------------------------------------------------------
Ir             I1mr ILmr Dr            D1mr        DLmr       Dw            D1mw    DLmw     file:function
--------------------------------------------------------------------------------
37,083,239,700    3    3 9,307,201,700 718,651,930 62,612,210 2,877,477,600       0       0  ???:StringSet::Find(char const*)
13,565,388,270    9    9 3,007,687,415 427,638,267  7,472,788             0       0       0  ???:__strcmp_avx2
 5,634,206,899    8    8   725,162,751  73,735,696 73,636,136   592,760,386 719,371 719,371  ???:test_real_words(char const*)
   583,581,717  273  272   582,735,173      26,694         60           515      23      14  ???:???
   499,056,714    7    7   123,225,133   6,812,127     62,515    41,347,664   3,464      27  ???:StringSet::Insert(char const*)
```

`C++ + ASM`:

```
--------------------------------------------------------------------------------
Ir             I1mr  ILmr  Dr             D1mr          DLmr        Dw            D1mw      DLmw      
--------------------------------------------------------------------------------
54,039,185,234 1,875 1,864 12,036,655,589 1,227,087,191 143,876,282 1,841,747,422 1,692,095 1,584,528  PROGRAM TOTALS

--------------------------------------------------------------------------------
Ir             I1mr ILmr Dr            D1mr        DLmr       Dw            D1mw    DLmw     file:function
--------------------------------------------------------------------------------
34,213,848,017  274  273 8,163,450,273 718,484,225 62,612,269 1,150,991,515      22      14  ???:???
13,565,386,170    9    9 3,007,686,915 427,462,769  7,472,789             0       0       0  ???:__strcmp_avx2
 5,634,206,899    8    8   725,162,751  73,735,695 73,636,136   592,760,386 719,371 719,371  ???:test_real_words(char const*)
   499,056,714    7    7   123,225,133   6,812,265     62,515    41,347,664   3,464      27  ???:StringSet::Insert(char const*)
```

На `-O2` уже не такой заметный прирост, но `StringSet::Find` снова пропал из топа тяжеловесных функций и тест упёрся в производительность `strcmp`. Общий прирост производительности -- `1.06` раза. 